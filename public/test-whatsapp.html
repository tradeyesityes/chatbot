<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>ÙØ­Øµ Ø§ØªØµØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f0fdf4;
        }

        .log-container {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
        }

        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        .log-time {
            color: #888;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .btn {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }

        .status {
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <h1>ğŸ› ï¸ ÙØ­Øµ Ø§ØªØµØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h1>

    <div class="status">
        <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:</h3>
        <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <button class="btn" onclick="startTest()">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ (Ù‚Ø±Ø§Ø¡Ø©)</button>
    <div id="test-actions" style="display:none; margin-top: 10px;">
        <button class="btn" onclick="testAI()" style="background:#8b5cf6">ÙØ­Øµ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
        <button class="btn" onclick="testSend()" style="background:#ea580c">ÙØ­Øµ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</button>
    </div>
    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Logs):</h3>
    <div class="log-container" id="logs"></div>

    <script>
        // Configuration from .env.local
        const SUPABASE_URL = 'https://rawobjxsbzpmlwwhmsec.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_KoIv4-t9vXXtEAbTlRDhmg_Gv0VYe2B'

        // Initialize Supabase
        // CDN provides 'supabase' global which has createClient
        const { createClient } = supabase
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY)

        function log(msg, type = 'info') {
            const container = document.getElementById('logs')
            const entry = document.createElement('div')
            entry.className = 'log-entry'
            entry.style.color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#4ade80' : '#fff')

            const time = new Date().toLocaleTimeString()
            entry.innerHTML = `<span class="log-time">${time}</span> ${msg}`

            container.appendChild(entry)
            container.scrollTop = container.scrollHeight
            console.log(msg)
        }

        window.onerror = function (msg, url, line) {
            log(`âŒ Global Error: ${msg} (Line ${line})`, 'error')
            return false
        }

        async function startTest() {
            log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ...', 'info')

            try {
                // 1. Check Session
                const { data: { session } } = await sb.auth.getSession()

                if (!session) {
                    log('âŒ Ø¨Ø¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ!', 'error')
                    document.getElementById('status').innerHTML = '<span style="color:red">ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>'
                    return
                }

                const userId = session.user.id
                log(`âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`, 'success')

                // 2. Fetch Settings
                const { data: settings, error } = await sb
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', userId)
                    .single()

                if (error || !settings) {
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ${error?.message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}`, 'error')
                    return
                }

                if (!settings.evolution_bot_enabled) {
                    log('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!', 'error')
                } else {
                    log('âœ… Ø§Ù„Ø¨ÙˆØª Ù…ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success')
                }

                const instanceName = settings.evolution_instance_name
                const baseUrl = settings.evolution_base_url.replace(/\/$/, '')
                const apiKey = settings.evolution_global_api_key || settings.evolution_api_key

                log(`ğŸ“¦ Instance: ${instanceName}`, 'info')
                log(`ğŸŒ Base URL: ${baseUrl}`, 'info')

                // 3. Check Connection State
                log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...', 'info')
                const connRes = await fetch(`${baseUrl}/instance/connectionState/${instanceName}`, {
                    headers: { 'apikey': apiKey }
                })

                const connData = await connRes.json()
                log(`Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${JSON.stringify(connData)}`, 'info')

                if (connData.instance?.state === 'open') {
                    log('âœ… ÙˆØ§ØªØ³Ø§Ø¨ Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²!', 'success')
                    document.getElementById('status').innerHTML = '<span style="color:green">âœ… Ù…ØªØµÙ„</span>'
                } else {
                    log('âŒ ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± Ù…ØªØµÙ„!', 'error')
                    document.getElementById('status').innerHTML = '<span style="color:red">âŒ ØºÙŠØ± Ù…ØªØµÙ„</span>'
                }

                // 4. Check Messages (POST)
                log('ğŸ“© Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...', 'info')
                const msgRes = await fetch(`${baseUrl}/chat/findMessages/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        where: {},
                        limit: 3
                    })
                })

                if (!msgRes.ok) {
                    log(`âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${msgRes.status}`, 'error')
                    const errText = await msgRes.text()
                    log(`ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: ${errText}`, 'error')
                    return
                }

                const messagesResponse = await msgRes.json()
                log(`ğŸ“¥ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„:`, 'info')
                // log(JSON.stringify(messagesResponse, null, 2), 'info')

                let messages = []
                if (Array.isArray(messagesResponse)) {
                    messages = messagesResponse
                } else if (messagesResponse.messages && Array.isArray(messagesResponse.messages.records)) {
                    messages = messagesResponse.messages.records
                } else if (messagesResponse.data && Array.isArray(messagesResponse.data)) {
                    messages = messagesResponse.data
                }

                log(`ğŸ“¥ ØªÙ… Ø¬Ù„Ø¨ ${messages.length} Ø±Ø³Ø§Ù„Ø©`, 'success')

                messages.forEach(msg => {
                    const fromMe = msg.key.fromMe ? 'Ù…Ù†ÙŠ' : 'Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„'
                    const text = msg.message?.conversation || msg.message?.extendedTextMessage?.text || 'Ø¨Ø¯ÙˆÙ† Ù†Øµ'
                    log(`- Ø±Ø³Ø§Ù„Ø© ${fromMe}: ${text}`, 'info')
                })

                log('âœ… ÙØ­Øµ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ÙƒØªÙ…Ù„.', 'success')
                document.getElementById('test-actions').style.display = 'block'

                // Store settings for other tests
                window.currentSettings = { baseUrl, instanceName, apiKey, settings }

            } catch (e) {
                log(`âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${e.message}`, 'error')
                console.error(e)
            }
        }

        async function testAI() {
            log('ğŸ¤– Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...', 'info')
            const { settings } = window.currentSettings

            // 1. Gemini
            if (settings.use_gemini) {
                const geminiKey = settings.gemini_api_key
                const modelName = settings.gemini_model_name || 'gemini-1.5-flash'
                log(`ğŸ”¹ Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„: Gemini (${modelName})`, 'info')

                if (!geminiKey) { log('âŒ Ù…ÙØªØ§Ø­ Gemini Ù…ÙÙ‚ÙˆØ¯!', 'error'); return }

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: 'Ù‚Ù„ ÙƒÙ„Ù…Ø© "Ù†Ø¬Ø§Ø­"' }] }] })
                    })
                    const data = await res.json()
                    if (data.candidates) {
                        log(`âœ… Gemini ÙŠØ¹Ù…Ù„: ${data.candidates[0].content.parts[0].text}`, 'success')
                    } else {
                        log(`âŒ Gemini ÙØ´Ù„: ${JSON.stringify(data)}`, 'error')
                    }
                } catch (e) { log(`âŒ Ø®Ø·Ø£ Gemini: ${e.message}`, 'error') }
                return
            }

            // 2. OpenAI
            if (settings.use_openai) {
                const openaiKey = settings.openai_api_key
                log('ğŸ”¹ Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„: OpenAI', 'info')

                if (!openaiKey) { log('âŒ Ù…ÙØªØ§Ø­ OpenAI Ù…ÙÙ‚ÙˆØ¯!', 'error'); return }

                try {
                    const res = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${openaiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages: [{ role: "user", content: "Ù‚Ù„ ÙƒÙ„Ù…Ø© Ù†Ø¬Ø§Ø­" }]
                        })
                    })
                    const data = await res.json()
                    if (data.choices) {
                        log(`âœ… OpenAI ÙŠØ¹Ù…Ù„: ${data.choices[0].message.content}`, 'success')
                    } else {
                        log(`âŒ OpenAI ÙØ´Ù„: ${JSON.stringify(data)}`, 'error')
                    }
                } catch (e) { log(`âŒ Ø®Ø·Ø£ OpenAI: ${e.message}`, 'error') }
                return
            }

            // 3. Ollama (Remote/Local)
            if (settings.use_remote_ollama || settings.use_local_model) {
                const isRemote = settings.use_remote_ollama
                const baseUrl = (isRemote ? settings.ollama_base_url : 'http://localhost:11434').replace(/\/$/, '')
                const model = isRemote ? settings.local_model_name : (settings.local_model_name || 'llama3')

                log(`ğŸ”¹ Ø§Ù„Ù…Ø²ÙˆØ¯ Ø§Ù„Ù…ÙØ¹Ù‘Ù„: Ollama (${isRemote ? 'Remote' : 'Local'})`, 'info')
                log(`ğŸ”— URL: ${baseUrl}, Model: ${model}`, 'info')

                // Proxy Logic (copied from ollamaService.ts)
                let endpoint = ''
                if (baseUrl.includes('ollama.com')) {
                    endpoint = '/api/ollama-cloud/api/chat'
                } else if (baseUrl.includes('localhost') || baseUrl.includes('127.0.0.1')) {
                    endpoint = '/api/ollama/api/chat'
                } else {
                    endpoint = `${baseUrl}/api/chat`
                }

                log(`ğŸ”„ Using Endpoint: ${endpoint}`, 'info')

                try {
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(isRemote && settings.ollama_api_key ? { 'Authorization': `Bearer ${settings.ollama_api_key}` } : {})
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [{ role: 'user', content: 'Ù‚Ù„ ÙƒÙ„Ù…Ø© Ù†Ø¬Ø§Ø­' }],
                            stream: false
                        })
                    })

                    if (!res.ok) {
                        const errText = await res.text()
                        log(`âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ (${res.status}): ${errText}`, 'error')
                        return
                    }

                    const data = await res.json()
                    const responseText = data.message?.content || data.response

                    if (responseText) {
                        log(`âœ… Ollama ÙŠØ¹Ù…Ù„: ${responseText}`, 'success')
                    } else {
                        log(`âŒ Ollama ÙØ´Ù„ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©): ${JSON.stringify(data)}`, 'error')
                    }
                } catch (e) { log(`âŒ Ø®Ø·Ø£ Ollama: ${e.message}`, 'error') }
                return
            }

            log('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø£ÙŠ Ù†Ù…ÙˆØ°Ø¬ AI ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!', 'error')
        }

        async function testSend() {
            const phone = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: 966500000000) Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©:')
            if (!phone) return

            log(`ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ${phone}...`, 'info')
            const { baseUrl, instanceName, apiKey } = window.currentSettings

            try {
                const res = await fetch(`${baseUrl}/message/sendText/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        number: phone,
                        text: 'Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ø§Ù„ØªØ´Ø®ÙŠØµ ğŸ› ï¸',
                        delay: 1200
                    })
                })

                if (res.ok) {
                    const data = await res.json()
                    log(`âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${JSON.stringify(data)}`, 'success')
                } else {
                    log(`âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${res.status} ${await res.text()}`, 'error')
                }
            } catch (e) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${e.message}`, 'error')
            }
        }
    </script>
</body>

</html>